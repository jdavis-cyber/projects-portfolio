<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>eBook Forge</title>

    <!-- React & DOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&family=Montserrat:wght@700;800;900&family=JetBrains+Mono:wght@400;500&family=Merriweather:ital,wght@0,300;0,400;0,700;1,300&display=swap"
        rel="stylesheet">

    <!-- Utilities -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.2/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>

    <style>
        /* J. DAVIS â€” ALGORITHMIC AUTHORITY THEME */
        body {
            background-color: #1A1A1A;
            background-image:
                linear-gradient(0deg, rgba(0, 240, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 240, 255, 0.03) 1px, transparent 1px);
            background-size: 40px 40px;
            background-attachment: fixed;
            font-family: 'Open Sans', 'Roboto', Arial, sans-serif;
            font-size: 16px;
            color: #E8E8E8;
            overflow: hidden;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1A1A1A;
        }

        ::-webkit-scrollbar-thumb {
            background: #2D2D2D;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #444444;
        }

        /* THE "INDUSTRY STANDARD" STYLESHEET */
        :root {
            --book-font-body: 'Merriweather', serif;
            --book-font-head: 'Merriweather', serif;
            --book-margin: 0.5in;
            --book-line-height: 1.6;
            --book-font-size: 12pt;
        }

        .galley-page {
            background: white;
            width: 8.5in;
            min-height: 11in;
            margin: 0 auto;
            padding: var(--book-margin);
            box-shadow: 0 0 50px -12px rgba(0, 0, 0, 0.5);
            font-family: var(--book-font-body);
            font-size: var(--book-font-size);
            line-height: var(--book-line-height);
            color: #111;
            text-align: justify;
            position: relative;

            hyphens: none !important;
            -webkit-hyphens: none !important;
            -ms-hyphens: none !important;
            word-break: normal !important;
            overflow-wrap: break-word !important;
        }

        /* FORCE UNIFORMITY: Override inline fonts from imported docs */
        .galley-page * {
            font-family: inherit !important;
        }

        /* MANUAL PAGE BREAK MARKER */
        .page-break-marker {
            border-top: 4px double #00F0FF;
            margin: 2em 0;
            position: relative;
            height: 20px;
            background: rgba(0, 240, 255, 0.05);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #00F0FF;
            font-family: 'Open Sans', sans-serif;
            font-size: 0.8em;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            cursor: default;
            user-select: none;
        }

        .page-break-marker::after {
            content: "FORCED PAGE BREAK";
        }

        .galley-page h1,
        .galley-page h2,
        .galley-page h3,
        .galley-page h4,
        .galley-page h5,
        .galley-page h6 {
            font-family: var(--book-font-head);
            font-weight: 700;
            margin-top: 1.5em;
            margin-bottom: 0.5em;
            color: #000;
            text-align: left;
            page-break-after: avoid;
            break-after: avoid;
        }

        .galley-page h1 {
            font-size: 2.2em;
            border-bottom: 2px solid #eee;
            padding-bottom: 0.2em;
        }

        .galley-page h2 {
            font-size: 1.6em;
        }

        .galley-page h3 {
            font-size: 1.3em;
            font-style: italic;
        }

        .galley-page p {
            margin-bottom: 1em;
            text-indent: 0;
        }

        .galley-page p.no-indent {
            text-indent: 0;
        }

        .galley-page img {
            max-width: 100%;
            height: auto;
            margin: 1em auto;
            display: block;
            border: 1px solid #eee;
        }

        /* IMAGE WRAPPING UTILITIES */
        .galley-page img.img-left {
            float: left;
            margin: 0.5em 1.5em 0.5em 0;
        }

        .galley-page img.img-right {
            float: right;
            margin: 0.5em 0 0.5em 1.5em;
        }

        .galley-page img.img-small {
            width: 25% !important;
        }

        .galley-page img.img-medium {
            width: 50% !important;
        }

        .galley-page img.img-large {
            width: 100% !important;
        }

        .galley-page ul {
            list-style-type: disc;
            margin-left: 2em;
            margin-bottom: 1em;
        }

        .galley-page li {
            margin-bottom: 0.5em;
        }

        /* --- INTELLIGENT TABLE ENGINE --- */
        .galley-page table {
            width: 100% !important;
            max-width: 100% !important;
            table-layout: auto !important;
            border-collapse: collapse;
            margin-top: 1.5em;
            margin-bottom: 1.5em;
            font-size: 8pt !important;
            page-break-inside: auto;
            break-inside: auto;
        }

        /* Remove gap between header and table */
        .galley-page h1+table,
        .galley-page h2+table,
        .galley-page h3+table,
        .galley-page h4+table,
        .galley-page h5+table,
        .galley-page h6+table {
            margin-top: 0 !important;
        }

        .galley-page div {
            page-break-inside: auto;
            break-inside: auto;
        }

        .galley-page thead {
            display: table-header-group;
        }

        .galley-page tfoot {
            display: table-footer-group;
        }

        .galley-page tr {
            page-break-inside: auto;
            break-inside: auto;
        }

        .galley-page th {
            border: 1px solid #cbd5e1;
            padding: 0.5em;
            background-color: #f1f5f9;
            font-weight: bold;
            text-align: center;
            vertical-align: middle;
        }

        .galley-page td {
            border: 1px solid #cbd5e1;
            padding: 0.5em;
            text-align: left;
            vertical-align: top;
            font-weight: normal;
        }

        .galley-page td,
        .galley-page th {
            word-wrap: normal !important;
            overflow-wrap: break-word !important;
            word-break: normal !important;
            white-space: normal !important;
            hyphens: none !important;
        }

        .keep-together {
            page-break-inside: avoid !important;
            break-inside: avoid !important;
            display: block;
            width: 100%;
        }

        /* DATA CARDS STYLES */
        .data-card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1rem;
            margin: 1.5rem 0;
            font-family: var(--book-font-head);
        }

        .data-card {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 1rem;
            background: #f9fafb;
            page-break-inside: avoid;
        }

        .data-card-row {
            margin-bottom: 0.5rem;
            display: flex;
            flex-direction: column;
        }

        .data-card-label {
            font-size: 0.75em;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #6b7280;
            font-weight: bold;
        }

        .data-card-value {
            font-size: 0.95em;
            color: #111;
            font-weight: normal;
        }

        .galley-page table p,
        .galley-page td *,
        .data-card-value * {
            text-indent: 0 !important;
            margin-bottom: 0;
            font-weight: normal !important;
        }

        .index-list {
            column-count: 2;
            column-gap: 2rem;
            font-size: 0.9em;
        }

        .index-item {
            margin-bottom: 0.5em;
            break-inside: avoid;
        }

        .index-term {
            font-weight: bold;
        }

        .index-locs {
            color: #555;
            font-style: italic;
            font-size: 0.9em;
        }

        /* J. DAVIS BRANDED BUTTON STATES */
        .jd-btn-primary {
            background-color: #00A8E8 !important;
            transition: all 0.2s ease;
        }

        .jd-btn-primary:hover {
            background-color: #00F0FF !important;
            box-shadow: 0 0 12px rgba(0, 240, 255, 0.3);
        }

        .jd-btn-primary:active {
            background-color: #0088CC !important;
        }

        .jd-btn-primary:disabled {
            background-color: #E0E0E0 !important;
            color: #999999 !important;
            box-shadow: none !important;
            cursor: not-allowed;
        }

        .jd-btn-secondary {
            border: 1px solid #00A8E8 !important;
            color: #C0C0C0 !important;
            transition: all 0.2s ease;
        }

        .jd-btn-secondary:hover {
            border-color: #00F0FF !important;
            color: #00F0FF !important;
            background-color: rgba(0, 240, 255, 0.1) !important;
        }

        .jd-toolbar-btn {
            color: #C0C0C0;
            transition: all 0.15s ease;
        }

        .jd-toolbar-btn:hover {
            color: #FFFFFF;
            background-color: rgba(255, 255, 255, 0.05);
        }

        /* SIDEBAR CHAPTER HOVER */
        .jd-chapter-item:hover {
            background-color: rgba(255, 255, 255, 0.03) !important;
            color: #E8E8E8 !important;
        }

        .jd-chapter-item .jd-trash:hover {
            color: #CC3333 !important;
        }

        /* DRAG-AND-DROP STYLES */
        .chapter-drop-above {
            border-top: 2px solid #00F0FF !important;
        }

        .chapter-drop-below {
            border-bottom: 2px solid #00F0FF !important;
        }

        .chapter-dragging {
            opacity: 0.4;
        }

        /* MODAL BACKDROP */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: #1A1A1A;
            border: 1px solid #2D2D2D;
            border-top: 2px solid #00F0FF;
            border-radius: 6px;
            padding: 2rem;
            width: 90%;
            max-width: 480px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .modal-content input,
        .modal-content select,
        .modal-content textarea {
            width: 100%;
            background: #FFFFFF;
            border: 1px solid #E0E0E0;
            border-radius: 4px;
            padding: 0.5rem 0.75rem;
            color: #2D2D2D;
            font-family: 'Open Sans', sans-serif;
            font-size: 14px;
            outline: none;
            margin-top: 0.25rem;
        }

        .modal-content input:focus,
        .modal-content select:focus,
        .modal-content textarea:focus {
            border-color: #00A8E8;
            box-shadow: 0 0 0 2px rgba(0, 168, 232, 0.15);
        }

        .modal-content label {
            display: block;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: #C0C0C0;
            margin-bottom: 0.5rem;
        }

        /* LIVE PAGE BREAK INDICATORS */
        .page-break-indicator {
            position: absolute;
            left: 0;
            right: 0;
            height: 0;
            border-top: 2px dashed rgba(0, 240, 255, 0.35);
            pointer-events: none;
            z-index: 10;
            user-select: none;
        }

        .page-break-indicator::after {
            content: attr(data-label);
            position: absolute;
            right: -10px;
            top: -10px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 9px;
            font-weight: 500;
            color: rgba(0, 240, 255, 0.6);
            background: rgba(26, 26, 26, 0.9);
            padding: 1px 8px;
            border-radius: 3px;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            white-space: nowrap;
        }

        @media print {

            .page-break-indicator {
                display: none !important;
            }

            html,
            body,
            #root,
            .app-interface,
            .flex-1,
            .overflow-y-auto,
            .overflow-hidden {
                height: auto !important;
                min-height: auto !important;
                overflow: visible !important;
                position: static !important;
                display: block !important;
            }

            /* HIDE GUI */
            .app-interface,
            header,
            aside,
            .no-print {
                display: none !important;
            }

            /* SHOW PRINT CONTAINER */
            .print-container {
                display: block !important;
            }

            .galley-page {
                box-shadow: none !important;
                margin: 0 !important;
                width: 100% !important;
                padding: 0 !important;
                border: none !important;
                height: auto !important;
                display: block !important;
            }

            .galley-page.cover-page {
                position: relative !important;
                width: 8.5in !important;
                height: 11in !important;
                margin: 0 !important;
                padding: 0 !important;
                overflow: hidden !important;
                page-break-after: always !important;
                break-after: always !important;
                left: 0 !important;
                top: 0 !important;
            }

            .cover-img-container {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                z-index: 10;
            }

            /* Force Page Breaks where marker exists */
            .page-break-marker {
                page-break-after: always !important;
                break-after: always !important;
                height: 0 !important;
                margin: 0 !important;
                border: none !important;
                visibility: hidden !important;
                content: "" !important;
                display: block !important;
            }

            h1,
            h2,
            h3,
            h4,
            h5 {
                page-break-after: avoid;
                break-after: avoid;
            }

            img,
            .data-card,
            figure {
                page-break-inside: avoid;
                break-inside: avoid;
            }

            .keep-together {
                page-break-inside: avoid !important;
                break-inside: avoid !important;
            }

            /* Force flex/grid to block for reliable pagination */
            .data-card-grid {
                display: block !important;
            }

            .data-card-row {
                display: block !important;
            }

            p,
            li {
                orphans: 2;
                widows: 2;
            }

            @page {
                margin: 0.5in;
                size: letter;
            }
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

        const { useState, useEffect, useRef, useCallback } = React;

        // --- LIVE PAGE BREAK CALCULATION ---
        function calculatePageBreaks(galleyEl) {
            if (!galleyEl) return [];

            const PAGE_CONTENT_HEIGHT = 960; // 10in at 96 CSS DPI
            const TOP_PADDING = 48;          // 0.5in top padding

            const totalHeight = galleyEl.scrollHeight;
            if (totalHeight <= TOP_PADDING + PAGE_CONTENT_HEIGHT) return []; // Fits on one page

            const breaks = [];

            // Collect forced page-break-marker positions
            const forcedBreaks = [];
            const markers = galleyEl.querySelectorAll('.page-break-marker');
            markers.forEach(marker => {
                forcedBreaks.push({ top: marker.offsetTop, bottom: marker.offsetTop + marker.offsetHeight });
            });
            forcedBreaks.sort((a, b) => a.top - b.top);

            let currentPageBottom = TOP_PADDING + PAGE_CONTENT_HEIGHT;
            let currentPage = 1;
            let forcedIdx = 0;

            while (currentPageBottom < totalHeight) {
                // Check if a forced break occurs before the next natural break
                if (forcedIdx < forcedBreaks.length && forcedBreaks[forcedIdx].top < currentPageBottom) {
                    currentPage++;
                    breaks.push({
                        page: currentPage,
                        topPx: forcedBreaks[forcedIdx].top,
                        forced: true
                    });
                    // New page starts after the marker with a full page budget
                    currentPageBottom = forcedBreaks[forcedIdx].bottom + PAGE_CONTENT_HEIGHT;
                    forcedIdx++;
                } else {
                    // Natural page break
                    currentPage++;
                    breaks.push({
                        page: currentPage,
                        topPx: currentPageBottom,
                        forced: false
                    });
                    currentPageBottom += PAGE_CONTENT_HEIGHT;
                }
            }

            return breaks;
        }

        // --- GEMINI API ---
        async function callGemini(prompt, key) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${key}`;
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: { responseMimeType: "application/json" }
            };
            const delays = [1000, 2000, 4000, 8000];
            for (let i = 0; i < 4; i++) {
                try {
                    const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const data = await response.json();
                    return data.candidates[0].content.parts[0].text;
                } catch (error) {
                    if (i === 3) throw error;
                    await new Promise(resolve => setTimeout(resolve, delays[i]));
                }
            }
        }

        // --- ICONS ---
        const IconBase = ({ children, size = 24, className = "" }) => (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>);
        const Book = (p) => <IconBase {...p}><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20" /><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z" /></IconBase>;
        const Trash2 = (p) => <IconBase {...p}><polyline points="3 6 5 6 21 6" /><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" /><line x1="10" y1="11" x2="10" y2="17" /><line x1="14" y1="11" x2="14" y2="17" /></IconBase>;
        const Printer = (p) => <IconBase {...p}><polyline points="6 9 6 2 18 2 18 9" /><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2" /><rect x="6" y="14" width="12" height="8" /></IconBase>;
        const AlertTriangle = (p) => <IconBase {...p}><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z" /><line x1="12" y1="9" x2="12" y2="13" /><line x1="12" y1="17" x2="12.01" y2="17" /></IconBase>;
        const FileUp = (p) => <IconBase {...p}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" /><polyline points="14 2 14 8 20 8" /><path d="M12 12v6" /><path d="M9 15l3-3 3 3" /></IconBase>;
        const Sparkles = (p) => <IconBase {...p}><path d="M9.937 15.5A2 2 0 0 0 8.5 14.063l-6.135-1.582a.5.5 0 0 1 0-.962L8.5 9.936A2 2 0 0 0 9.937 8.5l1.582-6.135a.5.5 0 0 1 .963 0L14.063 8.5A2 2 0 0 0 15.5 9.937l6.135 1.581a.5.5 0 0 1 0 .964L15.5 14.063a2 2 0 0 0-1.437 1.437l-1.582 6.135a.5.5 0 0 1-.963 0z" /></IconBase>;
        const Wrench = (p) => <IconBase {...p}><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z" /></IconBase>;
        const ListOrdered = (p) => <IconBase {...p}><line x1="10" y1="6" x2="21" y2="6" /><line x1="10" y1="12" x2="21" y2="12" /><line x1="10" y1="18" x2="21" y2="18" /><path d="M4 6h1v4" /><path d="M4 10h2" /><path d="M6 18H4c0-1 2-2 2-3s-1-1.5-2-1" /></IconBase>;
        const Save = (p) => <IconBase {...p}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" /><polyline points="17 21 17 13 7 13 7 21" /><polyline points="7 3 7 8 15 8" /></IconBase>;
        const RefreshCw = (p) => <IconBase {...p}><polyline points="23 4 23 10 17 10" /><polyline points="1 20 1 14 7 14" /><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15" /></IconBase>;
        const CheckCircle = (p) => <IconBase {...p}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" /><polyline points="22 4 12 14.01 9 11.01" /></IconBase>;
        const Layers = (p) => <IconBase {...p}><polygon points="12 2 2 7 12 12 22 7 12 2" /><polyline points="2 17 12 22 22 17" /><polyline points="2 12 12 17 22 12" /></IconBase>;
        const Eye = (p) => <IconBase {...p}><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" /><circle cx="12" cy="12" r="3" /></IconBase>;
        const Scissors = (p) => <IconBase {...p}><circle cx="6" cy="6" r="3" /><circle cx="6" cy="18" r="3" /><line x1="20" y1="4" x2="8.12" y2="15.88" /><line x1="14.47" y1="14.48" x2="20" y2="20" /><line x1="8.12" y1="8.12" x2="12" y2="12" /></IconBase>;
        const AlignLeft = (p) => <IconBase {...p}><line x1="17" y1="10" x2="3" y2="10" /><line x1="21" y1="6" x2="3" y2="6" /><line x1="21" y1="14" x2="3" y2="14" /><line x1="17" y1="18" x2="3" y2="18" /></IconBase>;
        const AlignCenter = (p) => <IconBase {...p}><line x1="18" y1="10" x2="6" y2="10" /><line x1="21" y1="6" x2="3" y2="6" /><line x1="21" y1="14" x2="3" y2="14" /><line x1="18" y1="18" x2="6" y2="18" /></IconBase>;
        const AlignRight = (p) => <IconBase {...p}><line x1="21" y1="10" x2="7" y2="10" /><line x1="21" y1="6" x2="3" y2="6" /><line x1="21" y1="14" x2="3" y2="14" /><line x1="21" y1="18" x2="7" y2="18" /></IconBase>;
        const Undo = (p) => <IconBase {...p}><path d="M3 7v6h6" /><path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13" /></IconBase>;
        const BoldIcon = (p) => <IconBase {...p}><path d="M6 4h8a4 4 0 0 1 4 4 4 4 0 0 1-4 4H6z"></path><path d="M6 12h9a4 4 0 0 1 4 4 4 4 0 0 1-4 4H6z"></path></IconBase>;
        const ItalicIcon = (p) => <IconBase {...p}><line x1="19" y1="4" x2="10" y2="4"></line><line x1="14" y1="20" x2="5" y2="20"></line><line x1="15" y1="4" x2="9" y2="20"></line></IconBase>;
        const ListIcon = (p) => <IconBase {...p}><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></IconBase>;
        const Eraser = (p) => <IconBase {...p}><path d="m7 21-4.3-4.3c-1-1-1-2.5 0-3.4l9.6-9.6c1-1 2.5-1 3.4 0l5.6 5.6c1 1 1 2.5 0 3.4L13 21" /><path d="M22 21H7" /><path d="m5 11 9 9" /></IconBase>;
        const Type = (p) => <IconBase {...p}><polyline points="4 7 4 4 20 4 20 7" /><line x1="9" y1="20" x2="15" y2="20" /><line x1="12" y1="4" x2="12" y2="20" /></IconBase>;
        const ImgSmall = (p) => <IconBase {...p}><rect x="3" y="3" width="18" height="18" rx="2" ry="2" /><rect x="6" y="6" width="6" height="6" /></IconBase>;
        const ImgLarge = (p) => <IconBase {...p}><rect x="3" y="3" width="18" height="18" rx="2" ry="2" /><rect x="3" y="3" width="18" height="18" /></IconBase>;
        const ImgLeft = (p) => <IconBase {...p}><rect x="3" y="3" width="18" height="18" rx="2" ry="2" /><rect x="6" y="6" width="6" height="6" /><line x1="14" y1="6" x2="18" y2="6" /><line x1="14" y1="10" x2="18" y2="10" /><line x1="6" y1="14" x2="18" y2="14" /></IconBase>;
        const ImgRight = (p) => <IconBase {...p}><rect x="3" y="3" width="18" height="18" rx="2" ry="2" /><rect x="12" y="6" width="6" height="6" /><line x1="6" y1="6" x2="10" y2="6" /><line x1="6" y1="10" x2="10" y2="10" /><line x1="6" y1="14" x2="18" y2="14" /></IconBase>;
        const Image = (p) => <IconBase {...p}><rect x="3" y="3" width="18" height="18" rx="2" ry="2" /><circle cx="8.5" cy="8.5" r="1.5" /><polyline points="21 15 16 10 5 21" /></IconBase>;
        const KeyIcon = (p) => <IconBase {...p}><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4" /></IconBase>;
        const PageBreakIcon = (p) => <IconBase {...p}><polyline points="6 14 6 18 18 18 18 14" /><line x1="6" y1="10" x2="18" y2="10" /><polyline points="6 6 6 2 18 2 18 6" /></IconBase>;



        // --- UTILITY: Process Content (Glue & Structure) ---
        const processContent = (htmlString) => {
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlString, 'text/html');

            // 0. RESET: Unwrap existing keep-together groups to reflow cleanly
            doc.querySelectorAll('.keep-together').forEach(wrapper => {
                const parent = wrapper.parentNode;
                while (wrapper.firstChild) parent.insertBefore(wrapper.firstChild, wrapper);
                parent.removeChild(wrapper);
            });

            // 1. GLUE HEADINGS TO CONTENT
            const headings = doc.querySelectorAll('h1, h2, h3, h4, h5, h6');
            headings.forEach(heading => {
                let next = heading.nextElementSibling;

                // CLEANUP: Remove empty spacers between header and content
                while (next && (next.tagName === 'P' || next.tagName === 'DIV') && next.innerText.trim() === '' && !next.querySelector('img') && !next.querySelector('table')) {
                    const toRemove = next;
                    next = next.nextElementSibling;
                    toRemove.remove();
                }

                if (next) {
                    let shouldWrap = false;
                    const tag = next.tagName;

                    // Wrap paragraphs and lists
                    if (tag === 'P' || tag === 'UL' || tag === 'OL') {
                        shouldWrap = true;
                    }
                    // Wrap DIVs ONLY if they do NOT contain a table
                    else if (tag === 'DIV' && !next.querySelector('table')) {
                        shouldWrap = true;
                    }

                    if (shouldWrap) {
                        if (heading.parentNode.className !== 'keep-together') {
                            const wrapper = doc.createElement('div');
                            wrapper.className = 'keep-together';
                            heading.parentNode.insertBefore(wrapper, heading);
                            wrapper.appendChild(heading);
                            wrapper.appendChild(next);
                        }
                    }
                }
            });
            return doc.body.innerHTML;
        };

        const countWords = (html) => {
            const div = document.createElement('div');
            div.innerHTML = html;
            const text = div.innerText || div.textContent || "";
            return text.trim().split(/\s+/).filter(w => w.length > 0).length;
        };

        // --- MAIN APP COMPONENT ---
        function App() {
            const [chapters, setChapters] = useState([]);
            const [activeChapterId, setActiveChapterId] = useState(null);
            const [isDragging, setIsDragging] = useState(false);
            const [processing, setProcessing] = useState(false);
            const [warnings, setWarnings] = useState([]);
            const [lastSaved, setLastSaved] = useState(null);
            const [coverImage, setCoverImage] = useState(null);
            const contentRef = useRef(null);

            // -- API KEY STATE --
            const [apiKey, setApiKey] = useState(() => localStorage.getItem('gemini_api_key') || '');
            const [showApiKeyModal, setShowApiKeyModal] = useState(false);

            // -- METADATA STATE --
            // -- CHAPTER RENAME STATE --
            const [editingChapterId, setEditingChapterId] = useState(null);
            const [editingTitle, setEditingTitle] = useState('');

            // -- DRAG REORDER STATE --
            const [dragChapterId, setDragChapterId] = useState(null);
            const [dropTargetId, setDropTargetId] = useState(null);
            const [dropPosition, setDropPosition] = useState(null);

            // -- PAGE BREAK INDICATORS --
            const [pageBreaks, setPageBreaks] = useState([]);

            // -- HISTORY ENGINE --
            const [history, setHistory] = useState([]);
            const [historyStep, setHistoryStep] = useState(-1);
            const isUndoing = useRef(false);

            useEffect(() => {
                if (isUndoing.current) {
                    isUndoing.current = false;
                    return;
                }
                setHistory(prev => {
                    const newHist = prev.slice(0, historyStep + 1);
                    newHist.push(chapters);
                    if (newHist.length > 20) newHist.shift();
                    return newHist;
                });
                setHistoryStep(prev => {
                    const next = prev + 1;
                    return next > 19 ? 19 : next;
                });
            }, [chapters]);

            const handleUndo = () => {
                if (historyStep > 0) {
                    isUndoing.current = true;
                    const prevIndex = historyStep - 1;
                    setChapters(history[prevIndex]);
                    setHistoryStep(prevIndex);
                }
            };

            // -- STORAGE ENGINE (IndexedDB via localforage) --
            useEffect(() => {
                localforage.config({ name: 'ebook_forge' });
                async function loadSession() {
                    try {
                        const savedChapters = await localforage.getItem('chapters');
                        const savedCover = await localforage.getItem('coverImage');
                        const savedActiveId = await localforage.getItem('activeChapterId');

                        if (savedChapters && Array.isArray(savedChapters) && savedChapters.length > 0) {
                            setChapters(savedChapters);
                            setWarnings(prev => [...prev, 'Session Restored from Local Cache.']);

                            if (savedActiveId) setActiveChapterId(savedActiveId);
                            else setActiveChapterId(savedChapters[0].id);
                        }

                        if (savedCover) setCoverImage(savedCover);
                    } catch (e) {
                        console.error("Storage Error:", e);
                        setWarnings(prev => [...prev, "Storage Load Error: " + e.message]);
                    }
                }
                loadSession();
            }, []);

            useEffect(() => {
                const saveSession = async () => {
                    if (chapters.length > 0 || coverImage) {
                        try {
                            await localforage.setItem('chapters', chapters);
                            if (coverImage) await localforage.setItem('coverImage', coverImage);
                            if (activeChapterId) await localforage.setItem('activeChapterId', activeChapterId);
                            setLastSaved(new Date().toLocaleTimeString());
                        } catch (e) {
                            console.error("Save failed:", e);
                        }
                    }
                };
                const timer = setTimeout(saveSession, 1000);
                return () => clearTimeout(timer);
            }, [chapters, coverImage, activeChapterId]);

            // -- DYNAMIC TABLE RESIZER --
            useEffect(() => {
                if (contentRef.current) {
                    const tables = contentRef.current.querySelectorAll('table');
                    tables.forEach(table => {
                        const cols = table.rows[0]?.cells.length || 0;
                        if (cols > 7) table.style.fontSize = '6pt';
                        else if (cols > 5) table.style.fontSize = '7pt';
                        else if (cols > 3) table.style.fontSize = '7.5pt';
                        else table.style.fontSize = '8pt';
                    });
                }
            }, [activeChapterId, chapters]);

            // -- PAGE BREAK INDICATOR CALCULATION --
            const ActiveChapter = chapters.find(c => c.id === activeChapterId);

            const recalculatePageBreaks = useCallback(() => {
                if (!contentRef.current) { setPageBreaks([]); return; }
                requestAnimationFrame(() => {
                    if (!contentRef.current) return;
                    const breaks = calculatePageBreaks(contentRef.current);
                    setPageBreaks(breaks);
                });
            }, []);

            // Recalculate on chapter switch or content change
            useEffect(() => {
                recalculatePageBreaks();
            }, [activeChapterId, ActiveChapter?.content, recalculatePageBreaks]);

            // ResizeObserver for image loads, font rendering, and window resize
            useEffect(() => {
                if (!contentRef.current) return;
                let debounceTimer = null;
                const observer = new ResizeObserver(() => {
                    clearTimeout(debounceTimer);
                    debounceTimer = setTimeout(recalculatePageBreaks, 150);
                });
                observer.observe(contentRef.current);
                return () => { observer.disconnect(); clearTimeout(debounceTimer); };
            }, [activeChapterId, recalculatePageBreaks]);

            const handleReset = () => {
                if (confirm("Reset Forge? This deletes all data.")) {
                    localforage.clear().then(() => {
                        setChapters([]);
                        setCoverImage(null);
                        setActiveChapterId(null);
                        setWarnings([]);
                    });
                    setCoverImage(null);
                    setActiveChapterId(null);
                    setWarnings([]);
                }
            };

            const handleReflow = () => {
                if (!activeChapterId) return;
                setProcessing(true);
                const currentChapter = chapters.find(c => c.id === activeChapterId);
                const reflowedContent = processContent(currentChapter.content);
                updateActiveContent(reflowedContent);
                setProcessing(false);
                setWarnings(prev => [...prev, "Reflow Complete."]);
            };

            const handleAlign = (type) => {
                document.execCommand(type, false, null);
                if (contentRef.current) updateActiveContent(contentRef.current.innerHTML);
            };

            const handleFormat = (command, value = null) => {
                document.execCommand(command, false, value);
                if (contentRef.current) updateActiveContent(contentRef.current.innerHTML);
            };

            const handleInsertPageBreak = () => {
                document.execCommand('insertHTML', false, '<div class="page-break-marker"></div>');
                if (contentRef.current) updateActiveContent(contentRef.current.innerHTML);
            };

            const handleImageFormat = (action) => {
                const selection = window.getSelection();
                if (!selection.rangeCount) return;

                let node = selection.anchorNode;
                if (node.nodeType === 3) node = node.parentNode;

                let img = null;
                if (selection.focusNode && selection.focusNode.querySelector) {
                    img = selection.focusNode.querySelector('img');
                }

                if (!img) {
                    const range = selection.getRangeAt(0);
                    const common = range.commonAncestorContainer;
                    if (common.nodeName === 'IMG') img = common;
                    else if (common.querySelector) img = common.querySelector('img');
                }

                if (!img && selection.anchorNode && selection.anchorNode.childNodes.length > 0) {
                    const child = selection.anchorNode.childNodes[selection.anchorOffset];
                    if (child && child.nodeName === 'IMG') img = child;
                }

                if (img) {
                    img.classList.remove('img-left', 'img-right', 'img-small', 'img-medium', 'img-large');

                    if (action === 'left') img.classList.add('img-left', 'img-medium');
                    if (action === 'right') img.classList.add('img-right', 'img-medium');
                    if (action === 'center') { /* Default is centered block */ }
                    if (action === 'small') img.classList.add('img-small');
                    if (action === 'medium') img.classList.add('img-medium');
                    if (action === 'large') img.classList.add('img-large');

                    if (contentRef.current) updateActiveContent(contentRef.current.innerHTML);
                } else {
                    setWarnings(prev => [...prev, "Select an image first to format it."]);
                }
            };

            const handlePrintPreview = () => {
                window.print();
            };

            const handleFileUpload = async (files) => {
                setProcessing(true);
                const newChapters = [];
                const newWarnings = [];
                for (let file of files) {
                    try {
                        let content = '';
                        let title = file.name.replace(/\.[^/.]+$/, "");
                        if (file.name.endsWith('.docx')) {
                            const arrayBuffer = await file.arrayBuffer();
                            const result = await mammoth.convertToHtml({ arrayBuffer });
                            if (result.messages.length > 0) newWarnings.push(`Word Warning (${file.name}): ${result.messages.map(m => m.message).join(', ')}`);
                            content = processContent(result.value);
                        } else if (file.name.endsWith('.pdf')) {
                            const arrayBuffer = await file.arrayBuffer();
                            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                            let fullText = "";
                            for (let i = 1; i <= pdf.numPages; i++) {
                                const page = await pdf.getPage(i);
                                const textContent = await page.getTextContent();
                                fullText += `<p>${textContent.items.map(item => item.str).join(' ')}</p>`;
                            }
                            content = fullText;
                            newWarnings.push(`PDF Notice (${file.name}): Tables in PDFs are flattened. Use 'Repair' to fix.`);
                        }
                        if (content) {
                            const wordCount = countWords(content);
                            newChapters.push({ id: Date.now() + Math.random(), title: title, content: content, wordCount: wordCount });
                        }
                    } catch (error) { newWarnings.push(`Error processing ${file.name}: ${error.message}`); }
                }
                setChapters(prev => [...prev, ...newChapters]);
                setWarnings(prev => [...prev, ...newWarnings]);
                setProcessing(false);
                if (newChapters.length > 0 && !activeChapterId) setActiveChapterId(newChapters[0].id);
            };

            const handleCoverUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        setCoverImage(e.target.result);
                        setActiveChapterId('COVER');
                    };
                    reader.readAsDataURL(file);
                }
            };

            const handleRepairSelection = async () => {
                if (!apiKey) {
                    setShowApiKeyModal(true);
                    return;
                }
                const selection = window.getSelection();
                if (!selection || selection.rangeCount === 0 || selection.toString().trim() === '') return setWarnings(prev => [...prev, "Select some messy text first."]);
                const range = selection.getRangeAt(0);
                const selectedHtml = (() => { const div = document.createElement('div'); div.appendChild(range.cloneContents()); return div.innerHTML; })();
                setProcessing(true);
                try {
                    const prompt = `Extract messy HTML/Text into clean JSON ARRAY of row objects. Keys=headers. Values=cells. Return ONLY JSON. Fragment: ${selectedHtml}`;
                    const responseText = await callGemini(prompt, apiKey);
                    const jsonData = JSON.parse(responseText);
                    let tableHtml = '<table><thead><tr>';
                    const keys = Object.keys(jsonData[0]);
                    keys.forEach(k => tableHtml += `<th>${k}</th>`);
                    tableHtml += '</tr></thead><tbody>';
                    jsonData.forEach(row => {
                        tableHtml += '<tr>';
                        keys.forEach(k => tableHtml += `<td>${row[k] || ''}</td>`);
                        tableHtml += '</tr>';
                    });
                    tableHtml += '</tbody></table>';
                    document.execCommand('insertHTML', false, tableHtml);
                    if (contentRef.current) updateActiveContent(contentRef.current.innerHTML);
                } catch (error) { setWarnings(prev => [...prev, `Repair Failed: ${error.message}`]); } finally { setProcessing(false); }
            };

            const updateActiveContent = (newContent) => setChapters(chapters.map(c => c.id === activeChapterId ? { ...c, content: newContent, wordCount: countWords(newContent) } : c));
            const onDrop = (e) => { e.preventDefault(); setIsDragging(false); handleFileUpload(e.dataTransfer.files); };
            const totalWords = chapters.reduce((acc, c) => acc + (c.wordCount || 0), 0);

            // -- CHAPTER RENAME HANDLERS --
            const startRename = (chap) => {
                setEditingChapterId(chap.id);
                setEditingTitle(chap.title);
            };

            const commitRename = () => {
                if (editingChapterId && editingTitle.trim()) {
                    setChapters(chapters.map(c => c.id === editingChapterId ? { ...c, title: editingTitle.trim() } : c));
                }
                setEditingChapterId(null);
                setEditingTitle('');
            };

            // -- CHAPTER DRAG REORDER HANDLERS --
            const handleChapterDragStart = (e, chapId) => {
                setDragChapterId(chapId);
                e.dataTransfer.effectAllowed = 'move';
            };

            const handleChapterDragOver = (e, chapId) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                if (chapId === dragChapterId) return;
                const rect = e.currentTarget.getBoundingClientRect();
                const midY = rect.top + rect.height / 2;
                setDropTargetId(chapId);
                setDropPosition(e.clientY < midY ? 'above' : 'below');
            };

            const handleChapterDragEnd = () => {
                if (dragChapterId && dropTargetId && dragChapterId !== dropTargetId) {
                    const dragIdx = chapters.findIndex(c => c.id === dragChapterId);
                    const dropIdx = chapters.findIndex(c => c.id === dropTargetId);
                    if (dragIdx !== -1 && dropIdx !== -1) {
                        const newChapters = [...chapters];
                        const [moved] = newChapters.splice(dragIdx, 1);
                        const insertIdx = dropPosition === 'above' ? (dropIdx > dragIdx ? dropIdx - 1 : dropIdx) : (dropIdx > dragIdx ? dropIdx : dropIdx + 1);
                        newChapters.splice(insertIdx, 0, moved);
                        setChapters(newChapters);
                    }
                }
                setDragChapterId(null);
                setDropTargetId(null);
                setDropPosition(null);
            };

            // -- API KEY MODAL SAVE --
            const saveApiKey = (key) => {
                localStorage.setItem('gemini_api_key', key);
                setApiKey(key);
                setShowApiKeyModal(false);
            };

            return (
                <div className="h-screen flex flex-col overflow-hidden">
                    <header className="text-white p-4 border-b sticky top-0 z-50 app-interface" style={{ backgroundColor: '#1A1A1A', borderColor: '#2D2D2D' }}>
                        <div className="max-w-7xl mx-auto flex justify-between items-center">
                            <div className="flex items-center space-x-3">
                                <Book style={{ color: '#00F0FF', filter: 'drop-shadow(0 0 6px rgba(0, 240, 255, 0.4))' }} size={26} />
                                <h1 style={{ fontFamily: "'Montserrat', sans-serif", letterSpacing: '0.08em', fontWeight: 800 }} className="text-xl text-white">eBOOK <span style={{ color: '#00F0FF' }}>FORGE</span></h1>
                                {lastSaved && <span className="text-[10px] font-mono ml-4 uppercase flex items-center" style={{ color: '#00A8E8', fontFamily: "'JetBrains Mono', monospace" }}><Save size={10} className="mr-1" /> Auto-Saved {lastSaved}</span>}
                            </div>
                            <div className="flex space-x-3">
                                <div className="flex rounded-lg p-1 border space-x-1" style={{ backgroundColor: '#2D2D2D', borderColor: '#444444' }}>
                                    <button onClick={handleUndo} disabled={historyStep <= 0} title="Undo" className="flex items-center space-x-2 px-3 py-2 rounded text-sm transition-all group disabled:opacity-30 disabled:cursor-not-allowed" style={{ color: '#C0C0C0' }}><Undo size={16} className="group-hover:-rotate-45 transition-transform" /> <span className="hidden 2xl:inline">Undo</span></button>
                                    <button onClick={handleRepairSelection} disabled={processing} title="Select text to repair" className="flex items-center space-x-2 px-3 py-2 rounded text-sm transition-all group" style={{ color: '#C0C0C0' }}><Wrench size={16} style={{ color: '#00F0FF' }} className="group-hover:rotate-12 transition-transform" /> <span className="hidden 2xl:inline">Repair</span></button>
                                    <button onClick={handleReflow} disabled={processing} title="Reflow Content" className="flex items-center space-x-2 px-3 py-2 rounded text-sm transition-all group" style={{ color: '#C0C0C0' }}><Layers size={16} style={{ color: '#00A8E8' }} className="group-hover:rotate-180 transition-transform" /> <span className="hidden 2xl:inline">Reflow</span></button>
                                </div>
                                <div className="h-9 w-px mx-1" style={{ backgroundColor: '#444444' }}></div>
                                <div className="flex rounded-lg p-1 border space-x-1 items-center" style={{ backgroundColor: '#2D2D2D', borderColor: '#444444' }}>
                                    <div className="relative">
                                        <Type size={14} className="absolute left-2 top-1/2 -translate-y-1/2 pointer-events-none" style={{ color: '#888888' }} />
                                        <select
                                            className="bg-transparent text-[11px] border-none rounded py-1 pl-7 pr-1 focus:outline-none cursor-pointer appearance-none font-medium w-24"
                                            style={{ color: '#C0C0C0' }}
                                            onChange={(e) => { if (e.target.value) handleFormat('formatBlock', e.target.value); e.target.value = ''; }}
                                            defaultValue=""
                                        >
                                            <option value="" disabled>Text Style</option>
                                            <option value="p" className="text-black">Normal Body</option>
                                            <option value="h1" className="text-black font-bold">Header 1</option>
                                            <option value="h2" className="text-black font-bold">Header 2</option>
                                            <option value="h3" className="text-black font-bold">Header 3</option>
                                            <option value="blockquote" className="text-black italic">Quote</option>
                                        </select>
                                    </div>
                                    <button onClick={() => handleFormat('removeFormat')} className="jd-toolbar-btn p-2 rounded" title="Reset / Clear Formatting"><Eraser size={16} /></button>
                                </div>
                                <div className="h-9 w-px mx-1" style={{ backgroundColor: '#444444' }}></div>
                                <div className="flex rounded-lg p-1 border space-x-1" style={{ backgroundColor: '#2D2D2D', borderColor: '#444444' }}>
                                    <button onClick={() => handleFormat('bold')} className="jd-toolbar-btn p-2 rounded" title="Bold"><BoldIcon size={16} /></button>
                                    <button onClick={() => handleFormat('italic')} className="jd-toolbar-btn p-2 rounded" title="Italic"><ItalicIcon size={16} /></button>
                                    <button onClick={() => handleFormat('insertUnorderedList')} className="jd-toolbar-btn p-2 rounded" title="List"><ListIcon size={16} /></button>
                                    <button onClick={handleInsertPageBreak} className="jd-toolbar-btn p-2 rounded" title="Insert Page Break"><PageBreakIcon size={16} /></button>
                                </div>
                                <div className="h-9 w-px mx-1" style={{ backgroundColor: '#444444' }}></div>
                                <div className="flex rounded-lg p-1 border space-x-1" style={{ backgroundColor: '#2D2D2D', borderColor: '#444444' }}>
                                    <button onClick={() => handleImageFormat('small')} className="jd-toolbar-btn p-2 rounded" title="Image: Small (25%)"><ImgSmall size={16} /></button>
                                    <button onClick={() => handleImageFormat('medium')} className="jd-toolbar-btn p-2 rounded" title="Image: Medium (50%)"><ImgLarge size={16} transform="scale(0.8)" /></button>
                                    <button onClick={() => handleImageFormat('large')} className="jd-toolbar-btn p-2 rounded" title="Image: Large (100%)"><ImgLarge size={16} /></button>
                                    <div className="w-px h-4 mx-1 self-center" style={{ backgroundColor: '#444444' }}></div>
                                    <button onClick={() => handleImageFormat('left')} className="jd-toolbar-btn p-2 rounded" title="Image: Float Left"><ImgLeft size={16} /></button>
                                    <button onClick={() => handleImageFormat('center')} className="jd-toolbar-btn p-2 rounded" title="Image: Center (Default)"><AlignCenter size={16} /></button>
                                    <button onClick={() => handleImageFormat('right')} className="jd-toolbar-btn p-2 rounded" title="Image: Float Right"><ImgRight size={16} /></button>
                                </div>
                                <div className="h-9 w-px mx-1" style={{ backgroundColor: '#444444' }}></div>
                                <div className="flex rounded-lg p-1 border space-x-1" style={{ backgroundColor: '#2D2D2D', borderColor: '#444444' }}>
                                    <button onClick={() => handleAlign('justifyLeft')} className="jd-toolbar-btn p-2 rounded" title="Align Left"><AlignLeft size={16} /></button>
                                    <button onClick={() => handleAlign('justifyCenter')} className="jd-toolbar-btn p-2 rounded" title="Align Center"><AlignCenter size={16} /></button>
                                    <button onClick={() => handleAlign('justifyRight')} className="jd-toolbar-btn p-2 rounded" title="Align Right"><AlignRight size={16} /></button>
                                </div>
                                <div className="h-9 w-px mx-1" style={{ backgroundColor: '#444444' }}></div>

                                <button onClick={() => setShowApiKeyModal(true)} title="API Key Settings" className="jd-btn-secondary flex items-center space-x-2 bg-transparent px-3 py-2 rounded text-sm"><KeyIcon size={16} /></button>
                                <button onClick={handlePrintPreview} title="Print / Generate PDF" className="jd-btn-primary flex items-center space-x-2 text-white px-5 py-2 rounded text-sm font-bold"><Printer size={16} /> <span className="hidden 2xl:inline">Print / PDF</span></button>
                            </div>
                        </div>
                    </header>

                    <div className="flex flex-1 overflow-hidden app-interface">
                        <aside className="w-72 border-r flex flex-col" style={{ backgroundColor: '#1A1A1A', borderColor: '#2D2D2D' }}>
                            <div className="p-4 border-b" style={{ borderColor: '#2D2D2D' }}>
                                <div className="flex justify-between items-center mb-3">
                                    <h2 className="text-[10px] font-bold uppercase tracking-[0.2em]" style={{ color: '#00F0FF' }}>Manuscript Core</h2>
                                    <button onClick={handleReset} title="Reset Project" style={{ color: '#888888' }} className="hover:text-red-400"><RefreshCw size={12} /></button>
                                </div>
                                <div
                                    className={`border border-dashed rounded-lg p-6 text-center cursor-pointer transition-all`}
                                    style={{ borderColor: isDragging ? '#00F0FF' : '#444444', backgroundColor: isDragging ? 'rgba(0, 240, 255, 0.05)' : 'transparent' }}
                                    onDragOver={(e) => { e.preventDefault(); setIsDragging(true); }}
                                    onDragLeave={() => setIsDragging(false)}
                                    onDrop={onDrop}
                                    onClick={() => document.getElementById('fileInput').click()}
                                >
                                    <FileUp className="mx-auto mb-3" style={{ color: '#C0C0C0' }} />
                                    <span className="text-xs block font-medium" style={{ color: '#C0C0C0' }}>Initialize Data Stream</span>
                                    <span className="text-[10px] block mt-1" style={{ color: '#888888' }}>(Drag .docx or .pdf)</span>
                                    <input id="fileInput" type="file" multiple className="hidden" accept=".docx,.pdf" onChange={(e) => handleFileUpload(e.target.files)} />
                                </div>


                                <div className="mt-2 border border-dashed rounded-lg p-3 text-center cursor-pointer transition-all" style={{ borderColor: '#444444' }} onClick={() => document.getElementById('coverInput').click()}>
                                    <div className="flex items-center justify-center space-x-2" style={{ color: '#C0C0C0' }}>
                                        <Image size={14} />
                                        <span className="text-xs font-medium">{coverImage ? 'Change Cover' : 'Upload Cover'}</span>
                                    </div>
                                    <input id="coverInput" type="file" className="hidden" accept="image/*" onChange={handleCoverUpload} />
                                </div>

                                {chapters.length > 0 && (
                                    <div className="mt-4 p-3 rounded flex justify-between items-center animate-pulse" style={{ backgroundColor: 'rgba(0, 240, 255, 0.05)', border: '1px solid rgba(0, 240, 255, 0.15)' }}>
                                        <div className="flex items-center" style={{ color: '#00F0FF' }}>
                                            <CheckCircle size={14} className="mr-2" />
                                            <span className="text-[10px] font-bold tracking-widest uppercase">System Nominal</span>
                                        </div>
                                        <span className="text-[10px] font-mono" style={{ color: '#E8E8E8', fontFamily: "'JetBrains Mono', monospace" }}>{totalWords.toLocaleString()} WORDS</span>
                                    </div>
                                )}
                            </div>

                            <div className="flex-1 overflow-y-auto">
                                {coverImage && (
                                    <div
                                        onClick={() => setActiveChapterId('COVER')}
                                        className={`p-3 cursor-pointer text-sm flex justify-between items-center group transition-all ${dragChapterId ? '' : ''}`}
                                        style={{ borderBottom: '1px solid #2D2D2D', borderLeft: activeChapterId === 'COVER' ? '2px solid #00F0FF' : '2px solid transparent', backgroundColor: activeChapterId === 'COVER' ? 'rgba(0, 240, 255, 0.05)' : 'transparent', color: activeChapterId === 'COVER' ? '#E8E8E8' : '#C0C0C0' }}
                                    >
                                        <div className="flex flex-col truncate w-48">
                                            <span className="text-[10px] opacity-50" style={{ fontFamily: "'JetBrains Mono', monospace" }}>COVER MODULE</span>
                                            <span className="truncate font-medium">Book Cover</span>
                                        </div>
                                        <button onClick={(e) => { e.stopPropagation(); setCoverImage(null); if (activeChapterId === 'COVER') setActiveChapterId(null); }} className="opacity-0 group-hover:opacity-100 transition-opacity" style={{ color: '#888888' }}><Trash2 size={14} /></button>
                                    </div>
                                )}
                                {chapters.map((chap, idx) => (
                                    <div
                                        key={chap.id}
                                        draggable
                                        onDragStart={(e) => handleChapterDragStart(e, chap.id)}
                                        onDragOver={(e) => handleChapterDragOver(e, chap.id)}
                                        onDragEnd={handleChapterDragEnd}
                                        onDragLeave={() => { if (dropTargetId === chap.id) { setDropTargetId(null); setDropPosition(null); } }}
                                        onClick={() => setActiveChapterId(chap.id)}
                                        className={`p-3 cursor-pointer text-sm flex justify-between items-center group transition-all ${dragChapterId === chap.id ? 'chapter-dragging' : ''} ${dropTargetId === chap.id && dropPosition === 'above' ? 'chapter-drop-above' : ''} ${dropTargetId === chap.id && dropPosition === 'below' ? 'chapter-drop-below' : ''}`}
                                        style={{ borderBottom: '1px solid #2D2D2D', borderLeft: activeChapterId === chap.id ? '2px solid #00F0FF' : '2px solid transparent', backgroundColor: activeChapterId === chap.id ? 'rgba(0, 240, 255, 0.05)' : 'transparent', color: activeChapterId === chap.id ? '#E8E8E8' : '#C0C0C0' }}
                                    >
                                        <div className="flex flex-col truncate w-48">
                                            <span className="text-[10px] opacity-50" style={{ fontFamily: "'JetBrains Mono', monospace" }}>SECT {String(idx + 1).padStart(2, '0')} â€¢ {(chap.wordCount || 0).toLocaleString()} WORDS</span>
                                            {editingChapterId === chap.id ? (
                                                <input
                                                    type="text"
                                                    value={editingTitle}
                                                    onChange={(e) => setEditingTitle(e.target.value)}
                                                    onBlur={commitRename}
                                                    onKeyDown={(e) => { if (e.key === 'Enter') commitRename(); if (e.key === 'Escape') { setEditingChapterId(null); setEditingTitle(''); } }}
                                                    autoFocus
                                                    onClick={(e) => e.stopPropagation()}
                                                    className="rounded px-1 py-0.5 text-sm outline-none font-medium"
                                                    style={{ backgroundColor: '#2D2D2D', border: '1px solid #00A8E8', color: '#E8E8E8' }}
                                                />
                                            ) : (
                                                <span className="truncate font-medium" onDoubleClick={(e) => { e.stopPropagation(); startRename(chap); }}>{chap.title}</span>
                                            )}
                                        </div>
                                        <button onClick={(e) => { e.stopPropagation(); setChapters(chapters.filter(c => c.id !== chap.id)); }} className="opacity-0 group-hover:opacity-100 transition-opacity" style={{ color: '#888888' }}><Trash2 size={14} /></button>
                                    </div>
                                ))}
                                {chapters.length === 0 && <div className="p-8 text-center text-xs" style={{ color: '#888888' }}><div className="mb-2 opacity-20"><Book size={32} className="mx-auto" /></div>Awaiting Input Data</div>}
                            </div>
                            {warnings.length > 0 && <div className="p-3 text-xs overflow-y-auto max-h-32" style={{ backgroundColor: 'rgba(204, 51, 51, 0.05)', borderTop: '1px solid rgba(204, 51, 51, 0.2)' }}><div className="flex items-center font-bold mb-1 tracking-wider text-[10px] uppercase" style={{ color: '#CC3333' }}><AlertTriangle size={10} className="mr-1" /> System Alerts</div><ul className="list-none pl-0 space-y-1 text-[10px]" style={{ color: '#C0C0C0', fontFamily: "'JetBrains Mono', monospace" }}>{warnings.map((w, i) => <li key={i} className="pl-2 py-0.5" style={{ borderLeft: '2px solid rgba(204, 51, 51, 0.3)' }}>{w}</li>)}</ul></div>}
                        </aside>

                        <main className="flex-1 flex flex-col relative overflow-hidden">
                            {activeChapterId === 'COVER' && coverImage ? (
                                <>
                                    <div className="w-full flex justify-center py-3 border-b z-10 shrink-0 app-interface" style={{ backgroundColor: '#2D2D2D', borderColor: '#444444' }}>
                                        <div className="w-full max-w-[8.5in] px-8 sm:px-0 text-[10px] text-right uppercase tracking-widest flex items-center justify-center" style={{ color: 'rgba(0, 240, 255, 0.4)', fontFamily: "'JetBrains Mono', monospace" }}>
                                            <span className="w-2 h-2 rounded-full mr-2 animate-pulse" style={{ backgroundColor: 'rgba(0, 240, 255, 0.5)' }}></span>
                                            Cover Preview // US Letter 8.5x11
                                        </div>
                                    </div>
                                    <div className="flex-1 overflow-y-auto p-8 flex flex-col items-center">
                                        <div className="w-full max-w-[8.5in] shadow-2xl">
                                            <div className="galley-page" style={{ height: '11in', position: 'relative', padding: 0, overflow: 'hidden' }}>
                                                <img src={coverImage} style={{ width: '100%', height: '100%', objectFit: 'cover' }} />
                                            </div>
                                        </div>
                                    </div>
                                </>
                            ) : ActiveChapter ? (
                                <>
                                    <div className="w-full flex justify-center py-3 border-b z-10 shrink-0 app-interface" style={{ backgroundColor: '#2D2D2D', borderColor: '#444444' }}>
                                        <div className="w-full max-w-[8.5in] px-8 sm:px-0 text-[10px] text-right uppercase tracking-widest flex items-center justify-center" style={{ color: 'rgba(0, 240, 255, 0.4)', fontFamily: "'JetBrains Mono', monospace" }}>
                                            <span className="w-2 h-2 rounded-full mr-2 animate-pulse" style={{ backgroundColor: 'rgba(0, 240, 255, 0.5)' }}></span>
                                            Live Preview // US Letter 8.5x11
                                        </div>
                                    </div>
                                    <div className="flex-1 overflow-y-auto p-8 flex flex-col items-center">
                                        <div className="w-full max-w-[8.5in]">
                                            <div style={{ position: 'relative' }}>
                                                <div
                                                    className="galley-page"
                                                    contentEditable
                                                    ref={contentRef}
                                                    suppressContentEditableWarning
                                                    onBlur={(e) => updateActiveContent(e.currentTarget.innerHTML)}
                                                    dangerouslySetInnerHTML={{ __html: ActiveChapter.content }}
                                                />
                                                {pageBreaks.filter(pb => !pb.forced).map((pb) => (
                                                    <div
                                                        key={`pb-${pb.page}`}
                                                        className="page-break-indicator"
                                                        data-label={`PAGE ${pb.page}`}
                                                        style={{ top: pb.topPx + 'px' }}
                                                    />
                                                ))}
                                            </div>
                                            <div className="mt-8 text-center text-xs app-interface" style={{ color: '#888888', fontFamily: "'JetBrains Mono', monospace" }}>// END OF DATA BLOCK</div>
                                        </div>
                                    </div>
                                </>
                            ) : (
                                <div className="h-full flex items-center justify-center" style={{ color: '#888888' }}>
                                    <div className="text-center">
                                        <div className="w-16 h-16 border rounded-full flex items-center justify-center mx-auto mb-4" style={{ borderColor: '#444444', backgroundColor: 'rgba(45, 45, 45, 0.3)' }}><Book size={24} className="opacity-50" /></div>
                                        <p className="font-light tracking-wide" style={{ fontFamily: "'Montserrat', sans-serif", letterSpacing: '0.05em' }}>SELECT A MODULE TO EDIT</p>
                                    </div>
                                </div>
                            )}
                        </main>
                    </div>

                    <div className="print-container hidden">
                        {coverImage && (
                            <div className="galley-page cover-page">
                                <div className="cover-img-container">
                                    <img src={coverImage} style={{ width: '100%', height: '100%', objectFit: 'fill', border: 'none' }} />
                                </div>
                            </div>
                        )}
                        {chapters.map((chap) => <div key={chap.id} className="galley-page"><div dangerouslySetInnerHTML={{ __html: chap.content }} /></div>)}
                    </div>

                    {/* API KEY MODAL */}
                    {showApiKeyModal && (
                        <div className="modal-backdrop" onClick={() => setShowApiKeyModal(false)}>
                            <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                                <h3 className="text-lg font-bold mb-4" style={{ color: '#00F0FF', fontFamily: "'Montserrat', sans-serif", letterSpacing: '0.05em' }}>GEMINI API KEY</h3>
                                <p className="text-xs mb-4" style={{ color: '#C0C0C0' }}>Enter your Google Gemini API key for the AI Repair feature. Your key is stored locally in your browser and never sent to any server except Google's API.</p>
                                <label>
                                    API Key
                                    <input
                                        type="password"
                                        defaultValue={apiKey}
                                        id="apiKeyInput"
                                        placeholder="AIzaSy..."
                                    />
                                </label>
                                <div className="flex justify-end space-x-3 mt-6">
                                    <button onClick={() => setShowApiKeyModal(false)} className="px-4 py-2 text-sm transition-colors" style={{ color: '#C0C0C0' }}>Cancel</button>
                                    <button onClick={() => saveApiKey(document.getElementById('apiKeyInput').value)} className="jd-btn-primary px-5 py-2 text-sm text-white rounded font-bold">Save Key</button>
                                </div>
                            </div>
                        </div>
                    )}

                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>
